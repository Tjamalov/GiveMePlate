<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ –º–µ—Å—Ç –ø–∏—Ç–∞–Ω–∏—è</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Manrope', sans-serif; background: #000; color: #fff; margin: 0; padding: 20px; text-align: center; }
        h1 { margin-bottom: 20px; }
        button { background: #fff; color: #000; border: none; padding: 12px 24px; border-radius: 16px; cursor: pointer; margin-bottom: 20px; }
        #map-container { position: relative; margin: 20px auto; max-width: 800px; }
        #map { height: 400px; width: 100%; border-radius: 16px; display: none; }
        #refresh-map { position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.7); color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; }
        #results { max-width: 800px; margin: 0 auto 20px; text-align: left; }
        .place { margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .place:hover { background: rgba(255,255,255,0.2); }
        .place-type { display: inline-block; padding: 2px 6px; background: rgba(255,255,255,0.2); border-radius: 4px; font-size: 0.8em; margin-left: 8px; }
        .divider { height: 1px; background: rgba(255,255,255,0.2); margin: 15px 0; position: relative; }
        .divider-text { position: absolute; top: -10px; left: 10px; background: #000; padding: 0 10px; font-size: 0.9em; color: rgba(255,255,255,0.6); }
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .loader { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #fff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        .highlighted { animation: highlight 1.5s ease-in-out; }
        .footer-link { display: block; margin-top: 30px; color: rgba(255,255,255,0.7); text-decoration: none; transition: color 0.2s; }
        .footer-link:hover { color: white; text-decoration: underline; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes highlight { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.7); } 70% { box-shadow: 0 0 0 10px rgba(255,255,255,0); } 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); } }
    </style>
</head>
<body>
    <h1>–ù–∞–π—Ç–∏ –º–µ—Å—Ç–∞ –ø–∏—Ç–∞–Ω–∏—è</h1>
    <button id="findPlacesBtn">–ò—Å–∫–∞—Ç—å –µ–¥—É</button>
    <div id="results"></div>
    <div id="map-container">
        <div id="map"></div>
        <button id="refresh-map" class="hidden">–û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É</button>
    </div>
    <a href="newest.html" class="footer-link">–ù–æ–≤—ã–µ –º–µ—Å—Ç–∞ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏</a>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, userMarker, placeMarkers = [], allPlaces = [], highlightedMarker = null;
        const placeTypes = { 'cafe':'–ö–∞—Ñ–µ', 'restaurant':'–†–µ—Å—Ç–æ—Ä–∞–Ω', 'fast_food':'–§–∞—Å—Ç—Ñ—É–¥', 'bar':'–ë–∞—Ä', 'pub':'–ü–∞–±', 'bistro':'–ë–∏—Å—Ç—Ä–æ', 'food_court':'–§—É–¥–∫–æ—Ä—Ç' };

        document.getElementById('findPlacesBtn').addEventListener('click', async () => {
            if (!navigator.geolocation) return alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
            document.getElementById('results').innerHTML = `<div class="loading"><div class="loader"></div><p>–ò—â–µ–º –º–µ—Å—Ç–∞ –ø–∏—Ç–∞–Ω–∏—è –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏...</p></div>`;
            
            navigator.geolocation.getCurrentPosition(async position => {
                const { latitude, longitude } = position.coords;
                if (!map) initMap(latitude, longitude);
                else { map.setView([latitude, longitude], 15); userMarker.setLatLng([latitude, longitude]); }
                document.getElementById('map').style.display = 'block';
                document.getElementById('refresh-map').classList.remove('hidden');
                allPlaces = (await findNearbyPlaces(latitude, longitude, 1000))
                    .filter(place => place.tags?.name?.trim() && place.type && place.type !== 'unknown');
                clearPlaceMarkers();
                displayPlaces(allPlaces);
            }, error => {
                document.getElementById('results').innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: ${error.message}</div>`;
            });
        });

        document.getElementById('refresh-map').addEventListener('click', () => {
            if (map) { map.invalidateSize(); map.eachLayer(layer => layer instanceof L.TileLayer && layer.redraw()); alert("–ö—ç—à –∫–∞—Ä—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω"); }
        });

        function initMap(lat, lon) {
            map = L.map('map').setView([lat, lon], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' 
            }).addTo(map);
            userMarker = L.marker([lat, lon], { 
                icon: L.divIcon({ className: 'user-marker', html: 'üìç', iconSize: [30,30] }) 
            }).addTo(map).bindPopup("–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ");
        }

        async function findNearbyPlaces(lat, lon, radius) {
            try {
                const response = await fetch(`https://overpass-api.de/api/interpreter?data=[out:json];(node["amenity"~"cafe|restaurant|fast_food|bar|pub|bistro|food_court"](around:${radius},${lat},${lon});way["amenity"~"cafe|restaurant|fast_food|bar|pub|bistro|food_court"](around:${radius},${lat},${lon});out body;>;out skel qt;`);
                const data = await response.json();
                return data.elements.map(element => ({
                    ...element, lat: element.lat || element.center?.lat, lon: element.lon || element.center?.lon,
                    distance: calculateDistance(lat, lon, element.lat || element.center?.lat, element.lon || element.center?.lon),
                    hasAddress: !!(element.tags?.['addr:street'] || element.tags?.['addr:housenumber']), type: element.tags?.amenity || 'unknown'
                })).sort((a, b) => (a.hasAddress === b.hasAddress) ? a.distance - b.distance : (a.hasAddress ? -1 : 1));
            } catch (error) { console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", error); return []; }
        }

        function displayPlaces(places) {
            const resultsDiv = document.getElementById('results');
            if (!places.length) { resultsDiv.innerHTML = "–ú–µ—Å—Ç–∞ –ø–∏—Ç–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏ üòû"; return; }
            
            const [withAddress, withoutAddress] = [places.filter(p => p.hasAddress), places.filter(p => !p.hasAddress)];
            let html = "<h3>–ë–ª–∏–∂–∞–π—à–∏–µ –º–µ—Å—Ç–∞ –ø–∏—Ç–∞–Ω–∏—è:</h3>";
            
            withAddress.slice(0,5).forEach((p,i) => html += createPlaceHtml(p,i));
            if (withoutAddress.length) {
                html += `<div class="divider"><span class="divider-text">–ë–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞</span></div>`;
                withoutAddress.slice(0,5).forEach((p,i) => html += createPlaceHtml(p,withAddress.length+i,true));
            }
            if (places.length > 10) html += `<div class="show-more"><button id="showAllBtn">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë (${places.length})</button></div>`;
            
            resultsDiv.innerHTML = html;
            placeMarkers = places.map((p,i) => p.lat ? L.marker([p.lat,p.lon],{riseOnHover:true}).addTo(map)
                .bindPopup(`<b>${p.tags?.name}</b><br>${placeTypes[p.type]?`<small>${placeTypes[p.type]}</small><br>`:''}${getAddress(p)||'–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}`) : null).filter(Boolean);
            
            document.querySelectorAll('.place').forEach(el => el.addEventListener('click', () => {
                const marker = placeMarkers[el.dataset.index];
                if (marker) { 
                    if (highlightedMarker) highlightedMarker.setZIndexOffset(0);
                    highlightedMarker = marker.setZIndexOffset(1000).openPopup();
                    map.setView(marker.getLatLng(),15);
                    marker.getElement().classList.add('highlighted');
                    setTimeout(() => marker.getElement().classList.remove('highlighted'),1500);
                    document.getElementById('map').scrollIntoView({behavior:'smooth'});
                }
            }));
            
            const showAllBtn = document.getElementById('showAllBtn');
            if (showAllBtn) showAllBtn.addEventListener('click', () => {
                resultsDiv.innerHTML = `<h3>–í—Å–µ –º–µ—Å—Ç–∞ –ø–∏—Ç–∞–Ω–∏—è:</h3>${withAddress.map((p,i)=>createPlaceHtml(p,i)).join('')}${withoutAddress.length?
                    `<div class="divider"><span class="divider-text">–ë–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞</span></div>${withoutAddress.map((p,i)=>createPlaceHtml(p,withAddress.length+i,true)).join('')}`:''}`;
                addPlaceClickHandlers();
            });
        }

        function createPlaceHtml(place, index, isNoAddress = false) {
            return `<div class="place ${isNoAddress?'no-address':''}" data-index="${index}"><strong>${place.tags?.name}</strong>${
                placeTypes[place.type]?`<span class="place-type">${placeTypes[place.type]}</span>`:''}<div>${Math.round(place.distance)} –º</div>${
                getAddress(place)||'–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>`;
        }

        function getAddress(place) {
            return [place.tags?.['addr:street'], place.tags?.['addr:housenumber']].filter(Boolean).join(' ');
        }

        function clearPlaceMarkers() {
            placeMarkers.forEach(marker => marker && map.removeLayer(marker));
            placeMarkers = [];
            highlightedMarker = null;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3, œÜ1 = lat1 * Math.PI/180, œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180, ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>
