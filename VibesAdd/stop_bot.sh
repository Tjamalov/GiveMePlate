#!/bin/bash

# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±–æ—Ç–∞
BOT_DIR="/home/Creogenka/VibesAdd"
LOG_FILE="$BOT_DIR/bot.log"

echo "=== –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–∞ ==="
echo "–í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S')"
echo "------------------------"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞
find_bot_processes() {
    # –ò—â–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ main.py
    pgrep -f "main.py" 2>/dev/null
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
get_process_info() {
    local pid=$1
    if [ -n "$pid" ]; then
        echo "PID: $pid"
        ps -p $pid -o %mem,%cpu,cmd --no-headers 2>/dev/null || echo "–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
}

# –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞
echo "üîç –ü–æ–∏—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞..."
PIDS=$(find_bot_processes)

if [ -z "$PIDS" ]; then
    echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    echo "=== –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ==="
    exit 0
fi

echo "üìã –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã:"
for pid in $PIDS; do
    echo "  - $(get_process_info $pid)"
done

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã..."
for pid in $PIDS; do
    echo "  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PID $pid..."
    kill $pid 2>/dev/null
    
    # –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã
    sleep 3
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
    if kill -0 $pid 2>/dev/null; then
        echo "  ‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å $pid –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º..."
        kill -9 $pid 2>/dev/null
        sleep 1
    else
        echo "  ‚úÖ –ü—Ä–æ—Ü–µ—Å—Å $pid –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    fi
done

# –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
REMAINING_PIDS=$(find_bot_processes)

if [ -z "$REMAINING_PIDS" ]; then
    echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "‚ùå –û—Å—Ç–∞–ª–∏—Å—å –ø—Ä–æ—Ü–µ—Å—Å—ã: $REMAINING_PIDS"
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Ö –≤—Ä—É—á–Ω—É—é:"
    echo "  kill -9 $REMAINING_PIDS"
fi

echo "------------------------"
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
tail -n 3 "$LOG_FILE" 2>/dev/null || echo "–õ–æ–≥ —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
echo "=== –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ===" 