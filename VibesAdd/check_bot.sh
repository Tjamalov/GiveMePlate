#!/bin/bash

# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±–æ—Ç–∞
BOT_DIR="/home/Creogenka/VibesAdd"
LOG_FILE="$BOT_DIR/bot.log"

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞ ==="
echo "–í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S')"
echo "------------------------"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –∑–∞–ø—É—â–µ–Ω –ª–∏ –±–æ—Ç
check_bot_running() {
    pgrep -f "python3.11 main.py" > /dev/null
    return $?
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –±–æ—Ç
if ! check_bot_running; then
    echo "‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
    
    # –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –µ–≥–æ
    cd "$BOT_DIR"
    nohup python3.11 main.py >> "$LOG_FILE" 2>&1 &
    
    # –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –±–æ—Ç —É—Å–ø–µ–ª –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
    sleep 5
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ª–∏ –±–æ—Ç
    if check_bot_running; then
        echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
        echo "üìù PID: $(pgrep -f 'python3.11 main.py')"
    else
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"
        echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ –∏–∑ –ª–æ–≥–∞:"
        tail -n 5 "$LOG_FILE"
    fi
else
    PID=$(pgrep -f 'python3.11 main.py')
    echo "‚úÖ –ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω"
    echo "üìù PID: $PID"
    echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞:"
    ps -p $PID -o %mem,%cpu,cmd | tail -n 1
fi

echo "------------------------"
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞:"
tail -n 5 "$LOG_FILE"
echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ===" 