#!/bin/bash

# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±–æ—Ç–∞
BOT_DIR="/home/Creogenka/VibesAdd"
LOG_FILE="$BOT_DIR/bot.log"

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞ ==="
echo "–í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S')"
echo "------------------------"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞
find_bot_processes() {
    # –ò—â–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ main.py (–±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–π –ø–æ–∏—Å–∫)
    pgrep -f "main.py" 2>/dev/null
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
get_process_info() {
    local pid=$1
    if [ -n "$pid" ]; then
        echo "PID: $pid"
        ps -p $pid -o %mem,%cpu,cmd --no-headers 2>/dev/null || echo "–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω—ã –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞
echo "üîç –ü–æ–∏—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞..."
PIDS=$(find_bot_processes)

if [ -z "$PIDS" ]; then
    echo "‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
    
    # –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –µ–≥–æ
    cd "$BOT_DIR"
    nohup python3.11 main.py >> "$LOG_FILE" 2>&1 &
    
    # –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –±–æ—Ç —É—Å–ø–µ–ª –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
    sleep 5
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ª–∏ –±–æ—Ç
    NEW_PIDS=$(find_bot_processes)
    if [ -n "$NEW_PIDS" ]; then
        echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
        for pid in $NEW_PIDS; do
            echo "üìù PID: $pid"
        done
    else
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"
        echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ –∏–∑ –ª–æ–≥–∞:"
        tail -n 5 "$LOG_FILE" 2>/dev/null || echo "–õ–æ–≥ —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    fi
else
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    PID_COUNT=$(echo "$PIDS" | wc -w)
    
    if [ "$PID_COUNT" -eq 1 ]; then
        echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (1 —ç–∫–∑–µ–º–ø–ª—è—Ä)"
        for pid in $PIDS; do
            echo "üìù PID: $pid"
            echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞:"
            get_process_info $pid
        done
    else
        echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ó–∞–ø—É—â–µ–Ω–æ $PID_COUNT —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–∞!"
        echo "üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
        for pid in $PIDS; do
            echo "  - $(get_process_info $pid)"
        done
        echo ""
        echo "üõë –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ:"
        echo "   ./stop_bot.sh"
        echo "   ./run_bot.sh"
    fi
fi

echo "------------------------"
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞:"
tail -n 5 "$LOG_FILE" 2>/dev/null || echo "–õ–æ–≥ —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ===" 